name: Deploy PRD via SCP + Compose

on:
  push:
    branches: [cliente1]  # ou use 'main' ou 'release' conforme seu fluxo

jobs:
  deploy:
    name: Deploy to PRD VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Copiar projeto para a VPS (inclui arquivos ocultos)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST_PRD }}
          username: ${{ secrets.SSH_USER_PRD }}
          key: ${{ secrets.SSH_KEY_PRD }}
          source: .
          target: /srv/erp/prd/

      - name: Executar docker-compose na VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST_PRD }}
          username: ${{ secrets.SSH_USER_PRD }}
          key: ${{ secrets.SSH_KEY_PRD }}
          script: |
            echo "ðŸ“¦ Acessando diretÃ³rio PRD"
            cd /srv/erp/prd

            echo "ðŸ›‘ Parando e removendo containers com nome contendo 'prd'..."
            docker ps -a --filter "name=prd" -q | xargs -r docker stop
            docker ps -a --filter "name=prd" -q | xargs -r docker rm

            echo "ðŸ§¹ Executando docker compose down para limpar Ã³rfÃ£os..."
            docker compose down --remove-orphans

            echo "ðŸš€ Subindo nova versÃ£o da aplicaÃ§Ã£o (produÃ§Ã£o)..."
            docker compose up -d --build
